##
## OTel Collector pipeline for AIR Blackbox Gateway.
##
## This config requires the custom collector built with OCB (see ocb-config.yaml).
## It wires the three AIR processors in order:
##   1. genai_semantic_normalizer — normalize vendor attrs to gen_ai.*
##   2. promptvault — offload content to storage, replace with vault refs
##   3. genaisafe — PII redaction, loop detection, token metrics
##   4. batch — standard batching before export
##

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  # Step 1: Normalize vendor-specific attributes to gen_ai.* semantic conventions.
  genai_semantic_normalizer:
    enable_defaults: true
    overwrite: false
    drop_original: false

  # Step 2: Offload prompt/response content to filesystem vault.
  promptvault:
    storage:
      backend: filesystem
      filesystem:
        base_path: /data/vault
    vault:
      keys:
        - gen_ai.system_instructions
        - gen_ai.input.messages
        - gen_ai.output.messages
        - gen_ai.prompt
        - gen_ai.completion
      size_threshold: 0
      mode: replace_with_ref

  # Step 3: PII redaction, token metrics, loop detection.
  genaisafe:
    redact:
      mode: hash_and_preview
      preview_chars: 48
      salt: air-demo-salt
      keys:
        - gen_ai.prompt
        - gen_ai.completion
        - llm.prompt
        - llm.completion
      denylist_regex:
        - "(?i)api[_-]?key"
        - "(?i)authorization"
        - "(?i)sk-[a-z0-9]{20,}"
    metrics:
      enable: true
    loop_detection:
      enable: true
      repeat_threshold: 6

  # Step 4: Standard batching before export.
  batch:
    timeout: 5s
    send_batch_size: 512

exporters:
  otlp/jaeger:
    endpoint: jaeger:4317
    tls:
      insecure: true

  debug:
    verbosity: basic

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [genai_semantic_normalizer, promptvault, genaisafe, batch]
      exporters: [otlp/jaeger, debug]
